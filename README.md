# Компонент "Ядро"

Компонент отвечает за маршрутизацию и доставку сообщений от одних компонентов/клиентов
к другим. Написан на TypeScript, Node.Js.

### Где и как развёрнут

Развёрнут на общем сервере через docker-compose (файл docker-compose.yaml),
порты 5051 для REST, 5052 для GRPC

### Где конфигурация

Конфигурация хостов всех компонентов указана в docker-compose, core -> environment.
Порты серверов ядра указаны в .env.
Обработчики компонентов прописываются в файлах проекта,
src/endpoints/index.ts (для информации, менять их никто не сможет)

### Как поднять

Поднять/остановить все описанные в docker-compose образы:  
`$ sudo docker compose up -d --build` (если нужен вывод, убрать -d)  
`$ sudo docker compose down`

Чтобы поднять локально, скопируйте файлы docker-compose.yaml и .env с сервера и выполните команды выше.

### Как делать запросы

Из-за специфики ядра как таковых тестовых запросов нет, потому что
для проверки запросов нужно минимум два узла - отправляющий и принимающий.
Поэтому проверить можно только "пустые" запросы, которые вернут ошибку о
невозможности подключения к конечной точке (конечно, пока не будет к ней доступа)

# REST API

Всего есть два запроса - _/api/v1/get_ и _/api/v1/set_.  
_/api/v1/get_ отвечает за получение данных во всех смыслах
(получение из хранилища, генерацию, исполнение и т.д.).
_/api/v1/set_ за установку значения (создание, обновление, удаление).
Эти запросы отличаются подходом к формированию и передаче данных.

### Библиотека модулей
[Документация компонента](https://gitlab.com/ansab3/codefragmentcontrolsystem/-/blob/main/USE.md?ref_type=heads)

| Описание                                                  | Запрос           | Тело запроса                                                                                                                                                                                                                                                                                         | Ответ                                                                                                                                                                                                                                   |
|-----------------------------------------------------------|------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Запрос списка <br>фрагментов кода**                     | POST /api/v1/get | <pre>{<br>   "requestType": "CODE_F_LIST"<br>}</pre>                                                                                                                                                                                                                                                 | **Multipart**<br>info: <pre>{<br>   "requestType": "CODE_F_LIST",<br>   "dataType": "JSON",<br>   "dataValueType": "codeFList",<br>   "codeFList": {<br>      "value": "json результат"<br>   }<br>}</pre>                              |
| **Запрос информации <br>о фрагменте кода**                | POST /api/v1/get | <pre>{<br>   "requestType": "CODE_F_INFO",<br>   "infoType": "codeFInfoGet",<br>   "codeFInfoGet": {<br>      "id": "идентификатор"<br>   }<br>}</pre>                                                                                                                                               | **Multipart**<br>info: <pre>{<br>   "requestType": "CODE_F_INFO",<br>   "dataType": "JSON",<br>   "dataValueType": "codeFInfo",<br>   "codeFInfo": {<br>      "value": "json результат"<br>   }<br>}</pre>                              |
| <span style="color:red">**Добавить фрагмент кода**</span> | POST /api/v1/set | **Multipart**<br>info: <pre>{<br>   "requestType": "CODE_F",<br>   "dataType": "BYTES",<br>   "dataValueType": "codeF",<br>   "codeF": {<br>      "getInfo": {<br>         "id": "Идентификатор ФК"<br>      },<br>      "value": "json фрагмента кода"<br>   }<br>}</pre><br>data: файл архива .tar | <pre>{<br>   "requestType": "CODE_F",<br>   "infoType": "response",<br>   "response": "ответ"<br>}</pre>                                                                                                                                |
| **Получить файлы <br>фрагмента кода**                     | POST /api/v1/get | <pre>{<br>   "requestType": "CODE_F",<br>   "infoType": "codeFGet",<br>   "codeFGet": {<br>      "id": "идентификатор"<br>   }<br>}</pre>                                                                                                                                                            | **Multipart**<br>info: <pre>{<br>   "requestType": "CODE_F",<br>   "dataType": "BYTES"<br>}</pre><br>data: файл архива .tar                                                                                                             |
| **Получить обработанный <br>плагином фрагмент кода**      | POST /api/v1/get | <pre>{<br>   "requestType": "CODE_F_PLUGIN_PROCEDURE",<br>   "infoType": "codeFPluginProcedureGet",<br>   "codeFPluginProcedureGet": {<br>      "codeFId": "идентификатор ФК",<br>      "type": "тип выполнения"<br>   }<br>}</pre>                                                                  | **Multipart**<br>info: <pre>{<br>   "requestType": "CODE_F_PLUGIN_PROCEDURE",<br>   "dataType": "JSON",<br>   "dataValueType": "codeFPluginProcedure",<br>   "codeFPluginProcedure": {<br>      "value": "результат"<br>   }<br>}</pre> |
| **Получить список <br>плагинов ФК**                       | POST /api/v1/get | <pre>{<br>   "requestType": "CODE_F_PLUGINS_LIST",<br>   "infoType": "codeFPluginsListGet",<br>   "codeFPluginsListGet": {<br>      "codeFId": "идентификатор"<br>   }<br>}</pre>                                                                                                                    | **Multipart**<br>info: <pre>{<br>   "requestType": "CODE_F_PLUGINS_LIST",<br>   "dataType": "JSON",<br>   "dataValueType": "codeFPluginsList",<br>   "codeFPluginsList": {<br>      "value": "результат"<br>   }<br>}</pre>             |
| <span style="color:red">**Добавить плагин**</span>        | POST /api/v1/set | **Multipart**<br>info: <pre>{<br>   "requestType": "CODE_F_PLUGIN",<br>   "dataType": "BYTES",<br>   "dataValueType": "codeFPlugin",<br>   "codeFPlugin": {<br>      "getInfo": {<br>         "pluginId": "идентификатор плагина"<br>      }<br>   }<br>}</pre><br>data: файл архива .tar            | <pre>{<br>   "requestType": "CODE_F_PLUGIN",<br>   "infoType": "response",<br>   "response": "ответ"<br>}</pre>                                                                                                                         |

### Хранилище переменных
[Документация компонента](https://t.me/c/1845197994/663/723)

| Описание                                                      | Запрос           | Тело запроса                                                                                                                                                                                                                                                                                                                                                                                                       | Ответ                                                                                                                                                                                                                                                                                                                                                                       |
|---------------------------------------------------------------|------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Получить переменную**                                       | POST /api/v1/get | <pre>{<br>   "requestType": "VAR",<br>   "infoType": "varGet",<br>   "varGet": {<br>      "id": "ID переменной"<br>   }<br>}</pre>                                                                                                                                                                                                                                                                                 | **Multipart**<br>info: <pre>{<br>   "requestType": "VAR",<br>   "dataType": "JSON",<br>   "dataValueType": "var",<br>   "var": {<br>      "getInfo": {<br>         "id": "ID переменной"<br>      },<br>      "value": {<br>         "name": "имя",<br>         "type": "string / file",<br>         "value": "строка / ссылка"<br>      }<br>   }<br>}</pre>               |
| **Добавить переменную**                                       | POST /api/v1/set | **Multipart**<br>info: <pre>{<br>   "requestType": "VAR",<br>   "dataType": "JSON",<br>   "dataValueType": "var",<br>   "var": {<br>      "value": {<br>         "name": "имя",<br>         "type": "string / file",<br>         "value": "строка / ссылка",<br>         "valueId": "ID значения (вместо value)"<br>      }<br>   }<br>}</pre>                                                                     | <pre>{<br>   "requestType": "VAR",<br>   "infoType": "varGet",<br>   "varGet": {<br>      "id": "ID переменной"<br>   }<br>}</pre>                                                                                                                                                                                                                                          |
| **Обновить переменную**                                       | POST /api/v1/set | **Multipart**<br>info: <pre>{<br>   "requestType": "VAR",<br>   "dataType": "JSON",<br>   "dataValueType": "var",<br>   "var": {<br>      "getInfo": {<br>         "id": "ID переменной"<br>      },<br>      "value": {<br>         "name": "имя",<br>         "type": "string / file",<br>         "value": "строка / ссылка",<br>         "valueId": "ID значения (вместо value)"<br>      }<br>   }<br>}</pre> | <pre>{<br>   "requestType": "VAR",<br>   "infoType": "varGet",<br>   "varGet": {<br>      "id": "ID переменной"<br>   }<br>}</pre>                                                                                                                                                                                                                                          |
| **Удалить переменную**                                        | POST /api/v1/get | <pre>{<br>   "requestType": "VAR_DELETE",<br>   "infoType": "varGet",<br>   "varGet": {<br>      "id": "ID переменной"<br>   }<br>}</pre>                                                                                                                                                                                                                                                                          | **Multipart**<br>info: <pre>{<br>   "requestType": "VAR_DELETE",<br>   "dataValueType": "var",<br>   "var": {<br>      "getInfo": {<br>         "id": "ID переменной"<br>      }<br>   }<br>}</pre>                                                                                                                                                                         | 
| **Получить значение переменной**                              | POST /api/v1/get | <pre>{<br>   "requestType": "VAR_VALUE",<br>   "infoType": "varValueGet",<br>   "varValueGet": {<br>      "id": "ID значения"<br>   }<br>}</pre>                                                                                                                                                                                                                                                                   | **Multipart**<br>info: <pre>{<br>   "requestType": "VAR_VALUE",<br>   "dataType": "JSON",<br>   "dataValueType": "varValue",<br>   "varValue": {<br>      "getInfo": {<br>         "id": "ID значения"<br>      },<br>      "value": {<br>         "name": "имя",<br>         "type": "string / file",<br>         "value": "строка / ссылка"<br>      }<br>   }<br>}</pre> |
| **Добавить значение переменной**                              | POST /api/v1/set | **Multipart**<br>info: <pre>{<br>   "requestType": "VAR_VALUE",<br>   "dataType": "JSON",<br>   "dataValueType": "varValue",<br>   "varValue": {<br>      "value": {<br>         "name": "имя",<br>         "type": "string / file",<br>         "value": "строка / ссылка",<br>      }<br>   }<br>}</pre>                                                                                                         | <pre>{<br>   "requestType": "VAR_VALUE",<br>   "infoType": "varValueGet",<br>   "varValueGet": {<br>      "id": "ID значения"<br>   }<br>}</pre>                                                                                                                                                                                                                            |
| **Обновить значение переменной**                              | POST /api/v1/set | **Multipart**<br>info: <pre>{<br>   "requestType": "VAR_VALUE",<br>   "dataType": "JSON",<br>   "dataValueType": "varValue",<br>   "varValue": {<br>      "getInfo": {<br>         "id": "ID значения"<br>      },<br>      "value": {<br>         "name": "имя",<br>         "type": "string / file",<br>         "value": "строка / ссылка",<br>      }<br>   }<br>}</pre>                                       | <pre>{<br>   "requestType": "VAR_VALUE",<br>   "infoType": "varValueGet",<br>   "varValueGet": {<br>      "id": "ID значения"<br>   }<br>}</pre>                                                                                                                                                                                                                            |
| **Удалить значение переменной**                               | POST /api/v1/get | <pre>{<br>   "requestType": "VAR_VALUE_DELETE",<br>   "infoType": "varValueGet",<br>   "varValueGet": {<br>      "id": "ID значения"<br>   }<br>}</pre>                                                                                                                                                                                                                                                            | **Multipart**<br>info: <pre>{<br>   "requestType": "VAR_VALUE_DELETE",<br>   "dataValueType": "varValue",<br>   "varValue": {<br>      "getInfo": {<br>         "id": "ID значения"<br>      }<br>   }<br>}</pre>                                                                                                                                                           | 
| <span style="color:red">**Загрузить файл**</span>             | POST /api/v1/set | **Multipart**<br>info: <pre>{<br>   "requestType": "VAR_ADD_FILE",<br>   "dataType": "BYTES"<br>}</pre><br>data: файл                                                                                                                                                                                                                                                                                              | <pre>{<br>   "requestType": "VAR_ADD_FILE",<br>   "infoType": "response",<br>   "response": "ссылка"<br>}</pre>                                                                                                                                                                                                                                                             |
| <span style="color:red">**Загрузить и сохранить файл**</span> | POST /api/v1/set | **Multipart**<br>info: <pre>{<br>   "requestType": "VAR_SET_FILE",<br>   "dataType": "BYTES",<br>   "dataValueType": "var",<br>   "var": {<br>      "getInfo": {<br>         "id": "ID переменной (если обновление)"<br>      },<br>      "value": {<br>         "name": "имя"<br>      }<br>   }<br>}</pre><br>data: файл                                                                                         | <pre>{<br>   "requestType": "VAR_SET_FILE",<br>   "infoType": "varGet",<br>   "varGet": {<br>      "id": "ID переменной"<br>   }<br>}</pre>                                                                                                                                                                                                                                 |
